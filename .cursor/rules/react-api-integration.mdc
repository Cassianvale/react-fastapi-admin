# React API é›†æˆè§„èŒƒ

## ğŸŒ API æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼ŒReact å‰ç«¯é€šè¿‡ HTTP API ä¸ FastAPI åç«¯è¿›è¡Œé€šä¿¡ã€‚

### åŸºç¡€é…ç½®

- **åç«¯åœ°å€**: `http://localhost:9999`
- **API ç‰ˆæœ¬**: `v1`
- **ä»£ç†è·¯å¾„**: `/api` â†’ `/api/v1`
- **è®¤è¯æ–¹å¼**: JWT Bearer Token

### æ ¸å¿ƒæ–‡ä»¶

- [react-web/src/utils/request.js](mdc:react-web/src/utils/request.js) - HTTP è¯·æ±‚å°è£…
- [react-web/src/api/index.js](mdc:react-web/src/api/index.js) - API æ¥å£å®šä¹‰

## ğŸ”§ HTTP è¯·æ±‚å°è£…

### 1. Axios å®ä¾‹é…ç½®

å‚è€ƒ: [react-web/src/utils/request.js](mdc:react-web/src/utils/request.js)

```javascript
import axios from "axios";

// åˆ›å»º axios å®ä¾‹
const request = axios.create({
  baseURL: "/api", // é€šè¿‡ Vite ä»£ç†åˆ°åç«¯
  timeout: 30000, // 30ç§’è¶…æ—¶
  headers: {
    "Content-Type": "application/json",
  },
});

// è¯·æ±‚æ‹¦æˆªå™¨
request.interceptors.request.use(
  (config) => {
    // æ·»åŠ è®¤è¯ Token
    const token = localStorage.getItem("token");
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }

    // æ·»åŠ è¯·æ±‚æ—¶é—´æˆ³ï¼ˆç”¨äºæ€§èƒ½ç›‘æ§ï¼‰
    config.metadata = { startTime: performance.now() };

    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  (response) => {
    // è®°å½•å“åº”æ—¶é—´
    const duration = performance.now() - response.config.metadata.startTime;
    console.log(
      `API ${response.config.url} å“åº”æ—¶é—´: ${duration.toFixed(2)}ms`
    );

    return response;
  },
  (error) => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    if (error.response?.status === 401) {
      // æ¸…é™¤è¿‡æœŸ token
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "/login";
    }

    return Promise.reject(error);
  }
);

export default request;
```

### 2. API æ¥å£å®šä¹‰

å‚è€ƒ: [react-web/src/api/index.js](mdc:react-web/src/api/index.js)

```javascript
import request from "@/utils/request";

// è®¤è¯ç›¸å…³æ¥å£
export const authApi = {
  // ç”¨æˆ·ç™»å½•
  login: (credentials) => request.post("/base/access_token", credentials),

  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  getCurrentUser: () => request.get("/base/userinfo"),

  // åˆ·æ–° Token
  refreshToken: (refreshToken) =>
    request.post("/base/refresh_token", { refresh_token: refreshToken }),
};

// ç”¨æˆ·ç®¡ç†æ¥å£
export const userApi = {
  // è·å–ç”¨æˆ·åˆ—è¡¨
  getUsers: (params) => request.get("/users/", { params }),

  // åˆ›å»ºç”¨æˆ·
  createUser: (userData) => request.post("/users/", userData),

  // æ›´æ–°ç”¨æˆ·
  updateUser: (id, userData) => request.put(`/users/${id}`, userData),

  // åˆ é™¤ç”¨æˆ·
  deleteUser: (id) => request.delete(`/users/${id}`),

  // è·å–å•ä¸ªç”¨æˆ·
  getUser: (id) => request.get(`/users/${id}`),
};

// è§’è‰²ç®¡ç†æ¥å£
export const roleApi = {
  getRoles: (params) => request.get("/roles/", { params }),
  createRole: (roleData) => request.post("/roles/", roleData),
  updateRole: (id, roleData) => request.put(`/roles/${id}`, roleData),
  deleteRole: (id) => request.delete(`/roles/${id}`),
  getRole: (id) => request.get(`/roles/${id}`),
};

// èœå•ç®¡ç†æ¥å£
export const menuApi = {
  getMenus: (params) => request.get("/menus/", { params }),
  createMenu: (menuData) => request.post("/menus/", menuData),
  updateMenu: (id, menuData) => request.put(`/menus/${id}`, menuData),
  deleteMenu: (id) => request.delete(`/menus/${id}`),
  getMenuTree: () => request.get("/menus/tree"),
};

// æ–‡ä»¶ä¸Šä¼ æ¥å£
export const uploadApi = {
  uploadFile: (file, onProgress) => {
    const formData = new FormData();
    formData.append("file", file);

    return request.post("/upload/file", formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
      onUploadProgress: (progressEvent) => {
        if (onProgress) {
          const progress = Math.round(
            (progressEvent.loaded * 100) / progressEvent.total
          );
          onProgress(progress);
        }
      },
    });
  },

  uploadImage: (file) => {
    const formData = new FormData();
    formData.append("image", file);
    return request.post("/upload/image", formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    });
  },
};
```

## ğŸ¯ API ä½¿ç”¨æ¨¡å¼

### 1. åŸºç¡€ API è°ƒç”¨

```jsx
import { useState, useEffect } from 'react';
import { userApi } from '@/api';
import { useErrorHandler } from '@/hooks/useErrorHandler';

const UserList = () => {
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(false);
  const { handleError } = useErrorHandler();

  const fetchUsers = async (params = {}) => {
    setLoading(true);
    try {
      const response = await userApi.getUsers(params);
      setUsers(response.data.items);
    } catch (error) {
      handleError(error, 'è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  return (
    // ç»„ä»¶å†…å®¹
  );
};
```

### 2. è‡ªå®šä¹‰ API Hook

```jsx
import { useState, useEffect, useCallback } from 'react';
import { useErrorHandler } from '@/hooks/useErrorHandler';

const useApi = (apiFunction, initialParams = null) => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const { handleError } = useErrorHandler();

  const execute = useCallback(async (params = initialParams) => {
    setLoading(true);
    setError(null);

    try {
      const response = await apiFunction(params);
      setData(response.data);
      return response.data;
    } catch (err) {
      setError(err);
      handleError(err);
      throw err;
    } finally {
      setLoading(false);
    }
  }, [apiFunction, initialParams, handleError]);

  useEffect(() => {
    if (initialParams !== null) {
      execute();
    }
  }, []);

  return { data, loading, error, execute };
};

// ä½¿ç”¨ç¤ºä¾‹
const UserProfile = ({ userId }) => {
  const { data: user, loading, execute: fetchUser } = useApi(
    userApi.getUser,
    userId
  );

  return (
    // ç»„ä»¶å†…å®¹
  );
};
```

### 3. åˆ†é¡µæ•°æ®å¤„ç†

```jsx
const usePagination = (apiFunction, pageSize = 10) => {
  const [data, setData] = useState([]);
  const [total, setTotal] = useState(0);
  const [current, setCurrent] = useState(1);
  const [loading, setLoading] = useState(false);
  const { handleError } = useErrorHandler();

  const fetchData = async (page = 1, size = pageSize, filters = {}) => {
    setLoading(true);
    try {
      const params = {
        page,
        size,
        ...filters,
      };

      const response = await apiFunction(params);
      setData(response.data.items);
      setTotal(response.data.total);
      setCurrent(page);
    } catch (error) {
      handleError(error, "è·å–æ•°æ®å¤±è´¥");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  return {
    data,
    total,
    current,
    loading,
    fetchData,
    pagination: {
      current,
      total,
      pageSize,
      onChange: (page, size) => fetchData(page, size),
      showSizeChanger: true,
      showQuickJumper: true,
      showTotal: (total, range) =>
        `ç¬¬ ${range[0]}-${range[1]} æ¡/å…± ${total} æ¡`,
    },
  };
};
```

### 4. è¡¨å•æäº¤å¤„ç†

```jsx
import { Form, message } from "antd";

const UserForm = ({ user, onSuccess }) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const { handleError, showSuccess } = useErrorHandler();

  const onFinish = async (values) => {
    setLoading(true);
    try {
      if (user?.id) {
        // æ›´æ–°ç”¨æˆ·
        await userApi.updateUser(user.id, values);
        showSuccess("ç”¨æˆ·æ›´æ–°æˆåŠŸ");
      } else {
        // åˆ›å»ºç”¨æˆ·
        await userApi.createUser(values);
        showSuccess("ç”¨æˆ·åˆ›å»ºæˆåŠŸ");
      }

      onSuccess?.();
      form.resetFields();
    } catch (error) {
      handleError(error, user?.id ? "æ›´æ–°ç”¨æˆ·å¤±è´¥" : "åˆ›å»ºç”¨æˆ·å¤±è´¥");
    } finally {
      setLoading(false);
    }
  };

  return (
    <Form
      form={form}
      onFinish={onFinish}
      initialValues={user}
      layout="vertical"
    >
      {/* è¡¨å•å­—æ®µ */}
      <Form.Item>
        <Button type="primary" htmlType="submit" loading={loading}>
          {user?.id ? "æ›´æ–°" : "åˆ›å»º"}
        </Button>
      </Form.Item>
    </Form>
  );
};
```

## ğŸ” è®¤è¯å’Œæƒé™

### 1. Token ç®¡ç†

```javascript
// Token å·¥å…·å‡½æ•°
export const tokenUtils = {
  getToken: () => localStorage.getItem("token"),

  setToken: (token) => localStorage.setItem("token", token),

  removeToken: () => {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
  },

  isTokenExpired: (token) => {
    if (!token) return true;

    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      return Date.now() >= payload.exp * 1000;
    } catch {
      return true;
    }
  },
};
```

### 2. è®¤è¯çŠ¶æ€ç®¡ç†

```jsx
const useAuth = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  const login = async (credentials) => {
    try {
      const response = await authApi.login(credentials);
      const { access_token, user: userInfo } = response.data;

      tokenUtils.setToken(access_token);
      localStorage.setItem("user", JSON.stringify(userInfo));
      setUser(userInfo);

      return userInfo;
    } catch (error) {
      throw error;
    }
  };

  const logout = () => {
    tokenUtils.removeToken();
    setUser(null);
  };

  const getCurrentUser = async () => {
    try {
      const response = await authApi.getCurrentUser();
      setUser(response.data);
      localStorage.setItem("user", JSON.stringify(response.data));
    } catch (error) {
      logout();
    }
  };

  useEffect(() => {
    const token = tokenUtils.getToken();
    const savedUser = localStorage.getItem("user");

    if (token && !tokenUtils.isTokenExpired(token) && savedUser) {
      setUser(JSON.parse(savedUser));
    } else if (token) {
      getCurrentUser();
    }

    setLoading(false);
  }, []);

  return { user, login, logout, loading };
};
```

## ğŸ“Š API æ€§èƒ½ä¼˜åŒ–

### 1. è¯·æ±‚å»é‡

```javascript
const requestCache = new Map();

const createRequestKey = (config) => {
  return `${config.method}_${config.url}_${JSON.stringify(
    config.params || {}
  )}`;
};

const dedupeRequest = (config) => {
  const key = createRequestKey(config);

  if (requestCache.has(key)) {
    return requestCache.get(key);
  }

  const request = axios(config);
  requestCache.set(key, request);

  // è¯·æ±‚å®Œæˆåæ¸…é™¤ç¼“å­˜
  request.finally(() => {
    requestCache.delete(key);
  });

  return request;
};
```

### 2. è¯·æ±‚ç¼“å­˜

```javascript
const apiCache = new Map();

const cachedRequest = async (config, cacheTime = 5 * 60 * 1000) => {
  const key = createRequestKey(config);
  const cached = apiCache.get(key);

  if (cached && Date.now() - cached.timestamp < cacheTime) {
    return cached.data;
  }

  const response = await axios(config);
  apiCache.set(key, {
    data: response,
    timestamp: Date.now(),
  });

  return response;
};
```

### 3. è¯·æ±‚é‡è¯•

```javascript
const retryRequest = async (config, maxRetries = 3) => {
  let lastError;

  for (let i = 0; i <= maxRetries; i++) {
    try {
      return await axios(config);
    } catch (error) {
      lastError = error;

      // åªé‡è¯•ç½‘ç»œé”™è¯¯å’Œ 5xx é”™è¯¯
      if (i < maxRetries && (!error.response || error.response.status >= 500)) {
        await new Promise((resolve) =>
          setTimeout(resolve, Math.pow(2, i) * 1000)
        );
        continue;
      }

      throw error;
    }
  }

  throw lastError;
};
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. API è®¾è®¡åŸåˆ™

- **RESTful è§„èŒƒ**: éµå¾ª REST API è®¾è®¡åŸåˆ™
- **ç»Ÿä¸€å“åº”æ ¼å¼**: æ‰€æœ‰æ¥å£è¿”å›ç»Ÿä¸€çš„æ•°æ®ç»“æ„
- **é”™è¯¯å¤„ç†**: æ˜ç¡®çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯
- **ç‰ˆæœ¬æ§åˆ¶**: é€šè¿‡ URL è·¯å¾„è¿›è¡Œç‰ˆæœ¬æ§åˆ¶

### 2. æ€§èƒ½ä¼˜åŒ–

- **è¯·æ±‚åˆå¹¶**: é¿å…åŒæ—¶å‘é€å¤šä¸ªç›¸ä¼¼è¯·æ±‚
- **æ•°æ®ç¼“å­˜**: åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚
- **åˆ†é¡µåŠ è½½**: å¤§æ•°æ®é›†ä½¿ç”¨åˆ†é¡µæˆ–è™šæ‹Ÿæ»šåŠ¨
- **æ‡’åŠ è½½**: æŒ‰éœ€åŠ è½½æ•°æ®å’Œç»„ä»¶

### 3. å®‰å…¨è€ƒè™‘

- **Token ç®¡ç†**: å®‰å…¨å­˜å‚¨å’Œä¼ è¾“è®¤è¯ Token
- **è¾“å…¥éªŒè¯**: å‰ç«¯éªŒè¯ç”¨æˆ·è¾“å…¥æ•°æ®
- **HTTPS**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HTTPS åè®®
- **CORS é…ç½®**: æ­£ç¡®é…ç½®è·¨åŸŸè¯·æ±‚

### 4. é”™è¯¯å¤„ç†

- **å…¨å±€å¤„ç†**: ç»Ÿä¸€å¤„ç†å¸¸è§é”™è¯¯ç±»å‹
- **ç”¨æˆ·å‹å¥½**: æ˜¾ç¤ºæ˜“æ‡‚çš„é”™è¯¯ä¿¡æ¯
- **é”™è¯¯æ¢å¤**: æä¾›é‡è¯•å’Œæ¢å¤æœºåˆ¶
- **æ—¥å¿—è®°å½•**: è®°å½•é”™è¯¯æ—¥å¿—ç”¨äºè°ƒè¯•
